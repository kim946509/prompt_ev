<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt 목록 - Prompt Evaluation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Claude 색상 팔레트 */
        :root {
            --claude-bg: #1a1a1a;
            --claude-surface: #2d2d2d;
            --claude-border: #404040;
            --claude-text: #e5e5e5;
            --claude-text-muted: #a0a0a0;
            --claude-accent: #cc785c;
            --claude-accent-hover: #b86b4f;
        }

        body {
            background-color: var(--claude-bg);
            color: var(--claude-text);
        }

        .card {
            background-color: var(--claude-surface);
            border: 1px solid var(--claude-border);
        }

        .btn-primary {
            background-color: var(--claude-accent);
        }

        .btn-primary:hover {
            background-color: var(--claude-accent-hover);
        }

        /* 프롬프트 펼치기/접기 */
        .prompt-collapsed {
            max-height: 3em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .prompt-expanded {
            max-height: none;
            white-space: pre-wrap;
        }

        /* 모달 오버레이 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        /* 모달 애니메이션 */
        .modal-content {
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen p-8">
    <div class="max-w-7xl mx-auto">
        <!-- 헤더 -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">Prompt 목록</h1>
            <p class="text-gray-400">저장된 프롬프트를 확인하고 평가하세요</p>
        </div>

        <!-- 필터 영역 -->
        <div class="card rounded-lg p-6 mb-6">
            <form th:action="@{/}" method="get" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- 카테고리 필터 -->
                    <div>
                        <label class="block text-sm font-medium mb-2">카테고리</label>
                        <select name="category" class="w-full px-3 py-2 bg-[#1a1a1a] border border-[#404040] rounded-md text-white focus:outline-none focus:border-[#cc785c]">
                            <option value="">전체</option>
                            <option th:each="cat : ${categories}"
                                    th:value="${cat}"
                                    th:text="${cat.description}"
                                    th:selected="${filter.category == cat}">
                            </option>
                        </select>
                    </div>

                    <!-- 최소 점수 -->
                    <div>
                        <label class="block text-sm font-medium mb-2">최소 만족도</label>
                        <input type="number" name="minSatisfaction"
                               th:value="${filter.minSatisfaction}"
                               min="0" max="10"
                               placeholder="0-10"
                               class="w-full px-3 py-2 bg-[#1a1a1a] border border-[#404040] rounded-md text-white focus:outline-none focus:border-[#cc785c]">
                    </div>

                    <!-- 최대 점수 -->
                    <div>
                        <label class="block text-sm font-medium mb-2">최대 만족도</label>
                        <input type="number" name="maxSatisfaction"
                               th:value="${filter.maxSatisfaction}"
                               min="0" max="10"
                               placeholder="0-10"
                               class="w-full px-3 py-2 bg-[#1a1a1a] border border-[#404040] rounded-md text-white focus:outline-none focus:border-[#cc785c]">
                    </div>

                    <!-- 페이지 크기 -->
                    <div>
                        <label class="block text-sm font-medium mb-2">페이지 크기</label>
                        <select name="size" class="w-full px-3 py-2 bg-[#1a1a1a] border border-[#404040] rounded-md text-white focus:outline-none focus:border-[#cc785c]">
                            <option th:each="size : ${pageSizes}"
                                    th:value="${size}"
                                    th:text="${size} + '개'"
                                    th:selected="${filter.size == size}">
                            </option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <a th:href="@{/}" class="px-4 py-2 bg-[#404040] text-white rounded-md hover:bg-[#4a4a4a] transition">
                        초기화
                    </a>
                    <button type="submit" class="btn-primary px-4 py-2 text-white rounded-md hover:bg-[#b86b4f] transition">
                        검색
                    </button>
                </div>
            </form>
        </div>

        <!-- 테이블 -->
        <div class="card rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-[#1a1a1a] border-b border-[#404040]">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">프로젝트</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">프롬프트</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">카테고리</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">만족도</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">생성일</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">작업</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#404040]">
                        <tr th:if="${#lists.isEmpty(prompts)}" class="hover:bg-[#333333] transition">
                            <td colspan="7" class="px-6 py-8 text-center text-gray-400">
                                저장된 프롬프트가 없습니다.
                            </td>
                        </tr>
                        <tr th:each="prompt : ${prompts}" class="hover:bg-[#333333] transition">
                            <td class="px-6 py-4 whitespace-nowrap text-sm" th:text="${prompt.id}"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400" th:text="${prompt.project}"></td>
                            <td class="px-6 py-4 text-sm">
                                <div class="max-w-md">
                                    <div th:id="'prompt-' + ${prompt.id}" class="prompt-collapsed" th:text="${prompt.content}"></div>
                                    <button th:if="${#strings.length(prompt.content) > 100}"
                                            th:attr="onclick='togglePrompt(' + ${prompt.id} + ')'"
                                            class="mt-1 text-xs text-[#cc785c] hover:text-[#b86b4f] flex items-center">
                                        <span th:id="'toggle-icon-' + ${prompt.id}">▼ 더보기</span>
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <select th:attr="onchange='updateCategory(' + ${prompt.id} + ', this.value)'"
                                        class="px-2 py-1 text-xs rounded bg-[#1a1a1a] border border-[#404040] text-[#cc785c] focus:outline-none focus:border-[#cc785c] cursor-pointer">
                                    <option value="">선택 안 함</option>
                                    <option th:each="cat : ${categories}"
                                            th:value="${cat}"
                                            th:text="${cat.description}"
                                            th:selected="${prompt.category == cat}">
                                    </option>
                                </select>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <input type="number"
                                       th:value="${prompt.overallSatisfaction}"
                                       th:attr="onchange='updateSatisfaction(' + ${prompt.id} + ', this.value)'"
                                       min="1" max="10"
                                       placeholder="-"
                                       class="w-16 px-2 py-1 text-center bg-[#1a1a1a] border border-[#404040] rounded text-white focus:outline-none focus:border-[#cc785c]">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400"
                                th:text="${#temporals.format(prompt.createdAt, 'yyyy-MM-dd HH:mm')}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                <div class="flex items-center justify-center space-x-2">
                                    <button onclick="openModal(this)"
                                            th:attr="data-id=${prompt.id},
                                                     data-content=${prompt.content},
                                                     data-category=${prompt.categoryDescription},
                                                     data-category-enum=${prompt.category},
                                                     data-project=${prompt.project},
                                                     data-ai-model=${prompt.aiModel},
                                                     data-created-at=${#temporals.format(prompt.createdAt, 'yyyy-MM-dd HH:mm')},
                                                     data-response-text=${prompt.responseText},
                                                     data-goal-achievement=${prompt.goalAchievement},
                                                     data-execution-success=${prompt.executionSuccess},
                                                     data-response-quality=${prompt.responseQuality},
                                                     data-efficiency=${prompt.efficiency},
                                                     data-reusability=${prompt.reusability},
                                                     data-overall-satisfaction=${prompt.overallSatisfaction},
                                                     data-comment=${prompt.comment},
                                                     data-ai-analysis=${prompt.aiAnalysis}"
                                            class="text-[#cc785c] hover:text-[#b86b4f] transition"
                                            title="상세보기">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                                        </svg>
                                    </button>
                                    <button th:attr="onclick='deletePrompt(' + ${prompt.id} + ')'"
                                            class="text-red-400 hover:text-red-300 transition"
                                            title="삭제">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 페이지네이션 -->
        <div th:if="${page.totalPages > 1}" class="mt-6 flex items-center justify-between">
            <div class="text-sm text-gray-400">
                총 <span th:text="${page.totalElements}"></span>개 중
                <span th:text="${page.number * page.size + 1}"></span>-<span th:text="${(page.number * page.size + page.size) < page.totalElements ? (page.number * page.size + page.size) : page.totalElements}"></span>
            </div>

            <div class="flex space-x-2">
                <!-- 이전 페이지 -->
                <a th:if="${!page.first}"
                   th:href="@{/(page=${page.number - 1}, size=${filter.size}, category=${filter.category}, minSatisfaction=${filter.minSatisfaction}, maxSatisfaction=${filter.maxSatisfaction})}"
                   class="px-3 py-2 bg-[#404040] text-white rounded-md hover:bg-[#4a4a4a] transition">
                    이전
                </a>
                <span th:if="${page.first}" class="px-3 py-2 bg-[#2d2d2d] text-gray-600 rounded-md cursor-not-allowed">
                    이전
                </span>

                <!-- 페이지 번호 -->
                <div class="flex space-x-1">
                    <th:block th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}">
                        <a th:if="${i >= page.number - 2 && i <= page.number + 2}"
                           th:href="@{/(page=${i}, size=${filter.size}, category=${filter.category}, minSatisfaction=${filter.minSatisfaction}, maxSatisfaction=${filter.maxSatisfaction})}"
                           th:classappend="${i == page.number} ? 'bg-[#cc785c] text-white' : 'bg-[#404040] text-white hover:bg-[#4a4a4a]'"
                           class="px-3 py-2 rounded-md transition"
                           th:text="${i + 1}">
                        </a>
                    </th:block>
                </div>

                <!-- 다음 페이지 -->
                <a th:if="${!page.last}"
                   th:href="@{/(page=${page.number + 1}, size=${filter.size}, category=${filter.category}, minSatisfaction=${filter.minSatisfaction}, maxSatisfaction=${filter.maxSatisfaction})}"
                   class="px-3 py-2 bg-[#404040] text-white rounded-md hover:bg-[#4a4a4a] transition">
                    다음
                </a>
                <span th:if="${page.last}" class="px-3 py-2 bg-[#2d2d2d] text-gray-600 rounded-md cursor-not-allowed">
                    다음
                </span>
            </div>
        </div>
    </div>

    <!-- 상세보기 모달 -->
    <div id="detailModal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-overlay" onclick="closeModal(event)">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="modal-content card rounded-lg max-w-4xl w-full p-8" onclick="event.stopPropagation()">
                <!-- 모달 헤더 -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">프롬프트 상세 정보</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">×</button>
                </div>

                <!-- 모달 내용 -->
                <div class="space-y-6">
                    <!-- 기본 정보 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-400">ID</span>
                            <p id="modal-id" class="text-lg font-semibold"></p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400 block mb-2">카테고리</span>
                            <select id="edit-category" class="w-full px-3 py-2 bg-[#2d2d2d] border border-[#404040] rounded-md text-white focus:outline-none focus:border-[#cc785c]">
                                <option value="">선택 안 함</option>
                                <option th:each="cat : ${categories}"
                                        th:value="${cat}"
                                        th:text="${cat.description}">
                                </option>
                            </select>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">프로젝트</span>
                            <p id="modal-project" class="text-lg"></p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">AI 모델</span>
                            <p id="modal-aiModel" class="text-lg"></p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-400">생성일</span>
                            <p id="modal-createdAt" class="text-lg"></p>
                        </div>
                    </div>

                    <!-- 프롬프트 내용 -->
                    <div>
                        <span class="text-sm text-gray-400">프롬프트 내용</span>
                        <div id="modal-content" class="mt-2 p-4 bg-[#1a1a1a] rounded-lg whitespace-pre-wrap"></div>
                    </div>

                    <!-- AI 응답 -->
                    <div id="modal-response-section">
                        <span class="text-sm text-gray-400">AI 응답</span>
                        <textarea id="edit-responseText" class="mt-2 w-full px-4 py-3 bg-[#1a1a1a] border border-[#404040] rounded-lg text-white" rows="6" placeholder="AI 응답 내용을 입력하세요"></textarea>
                    </div>

                    <!-- 평가 점수 -->
                    <div id="modal-scores-section">
                        <span class="text-sm text-gray-400 block mb-3">평가 점수</span>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-[#1a1a1a] p-4 rounded-lg">
                                <p class="text-xs text-gray-400 mb-2">목표 달성도 (1-10점)</p>
                                <input type="number" id="edit-goalAchievement" class="w-full px-3 py-2 bg-[#2d2d2d] border border-[#404040] rounded-md text-white" min="1" max="10" placeholder="1-10">
                            </div>
                            <div class="bg-[#1a1a1a] p-4 rounded-lg">
                                <p class="text-xs text-gray-400 mb-2">응답 품질 (1-10점)</p>
                                <input type="number" id="edit-responseQuality" class="w-full px-3 py-2 bg-[#2d2d2d] border border-[#404040] rounded-md text-white" min="1" max="10" placeholder="1-10">
                            </div>
                            <div class="bg-[#1a1a1a] p-4 rounded-lg">
                                <p class="text-xs text-gray-400 mb-2">효율성 (1-10점)</p>
                                <input type="number" id="edit-efficiency" class="w-full px-3 py-2 bg-[#2d2d2d] border border-[#404040] rounded-md text-white" min="1" max="10" placeholder="1-10">
                            </div>
                            <div class="bg-[#1a1a1a] p-4 rounded-lg">
                                <p class="text-xs text-gray-400 mb-2">재사용 가능성 (1-10점)</p>
                                <input type="number" id="edit-reusability" class="w-full px-3 py-2 bg-[#2d2d2d] border border-[#404040] rounded-md text-white" min="1" max="10" placeholder="1-10">
                            </div>
                            <div class="bg-[#1a1a1a] p-4 rounded-lg">
                                <p class="text-xs text-gray-400 mb-2">실행 성공 여부</p>
                                <select id="edit-executionSuccess" class="w-full px-3 py-2 bg-[#2d2d2d] border border-[#404040] rounded-md text-white">
                                    <option value="">선택 안 함</option>
                                    <option value="true">성공</option>
                                    <option value="false">실패</option>
                                </select>
                            </div>
                            <div class="bg-[#1a1a1a] p-4 rounded-lg">
                                <p class="text-xs text-gray-400 mb-2">종합 만족도 (1-10점)</p>
                                <input type="number" id="edit-overallSatisfaction" class="w-full px-3 py-2 bg-[#2d2d2d] border border-[#404040] rounded-md text-white" min="1" max="10" placeholder="1-10">
                            </div>
                        </div>
                    </div>

                    <!-- AI 분석 결과 -->
                    <div id="modal-ai-analysis-section">
                        <span class="text-sm text-gray-400">AI 분석 결과</span>
                        <div id="modal-ai-analysis" class="mt-2 p-4 bg-[#1a1a1a] rounded-lg whitespace-pre-wrap text-sm">
                            <span class="text-gray-500">분석 중...</span>
                        </div>
                    </div>

                    <!-- 코멘트 -->
                    <div id="modal-comment-section">
                        <span class="text-sm text-gray-400">코멘트</span>
                        <textarea id="edit-comment" class="mt-2 w-full px-4 py-3 bg-[#1a1a1a] border border-[#404040] rounded-lg text-white" rows="4" placeholder="자유 코멘트를 입력하세요"></textarea>
                    </div>
                </div>

                <!-- 모달 푸터 -->
                <div class="mt-8 flex justify-between">
                    <button onclick="deletePromptFromModal()" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                        삭제
                    </button>
                    <div class="flex space-x-3">
                        <button onclick="closeModal()" class="px-6 py-2 bg-[#404040] text-white rounded-md hover:bg-[#4a4a4a] transition">
                            닫기
                        </button>
                        <button onclick="savePrompt()" class="px-6 py-2 bg-[#cc785c] text-white rounded-md hover:bg-[#b86b4f] transition">
                            저장
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 프롬프트 펼치기/접기
        function togglePrompt(id) {
            const promptEl = document.getElementById('prompt-' + id);
            const iconEl = document.getElementById('toggle-icon-' + id);

            if (promptEl.classList.contains('prompt-collapsed')) {
                promptEl.classList.remove('prompt-collapsed');
                promptEl.classList.add('prompt-expanded');
                iconEl.textContent = '▲ 접기';
            } else {
                promptEl.classList.add('prompt-collapsed');
                promptEl.classList.remove('prompt-expanded');
                iconEl.textContent = '▼ 더보기';
            }
        }

        // 카테고리 업데이트
        async function updateCategory(id, category) {
            const requestBody = {
                category: category === '' ? null : category
            };

            try {
                const response = await fetch(`/api/prompts/${id}/category`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    // 성공 시 페이지 새로고침 없이 조용히 업데이트
                    console.log('카테고리가 업데이트되었습니다.');
                } else {
                    const error = await response.text();
                    alert('카테고리 업데이트 중 오류가 발생했습니다: ' + error);
                    location.reload(); // 실패 시 롤백을 위한 새로고침
                }
            } catch (error) {
                alert('카테고리 업데이트 중 오류가 발생했습니다: ' + error.message);
                location.reload();
            }
        }

        // 만족도 업데이트
        async function updateSatisfaction(id, satisfaction) {
            const satisfactionValue = satisfaction === '' ? null : parseInt(satisfaction);

            // 유효성 검사
            if (satisfactionValue !== null && (satisfactionValue < 1 || satisfactionValue > 10)) {
                alert('만족도는 1-10 사이의 값이어야 합니다.');
                location.reload();
                return;
            }

            const requestBody = {
                overallSatisfaction: satisfactionValue
            };

            try {
                const response = await fetch(`/api/prompts/${id}/satisfaction`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    // 성공 시 페이지 새로고침 없이 조용히 업데이트
                    console.log('만족도가 업데이트되었습니다.');
                } else {
                    const error = await response.text();
                    alert('만족도 업데이트 중 오류가 발생했습니다: ' + error);
                    location.reload();
                }
            } catch (error) {
                alert('만족도 업데이트 중 오류가 발생했습니다: ' + error.message);
                location.reload();
            }
        }

        // 현재 편집 중인 프롬프트 ID 저장
        let currentPromptId = null;

        // 모달 열기
        function openModal(button) {
            const dataset = button.dataset;
            currentPromptId = dataset.id;

            // 기본 정보 (읽기 전용)
            document.getElementById('modal-id').textContent = dataset.id || '-';
            document.getElementById('modal-project').textContent = dataset.project || '-';
            document.getElementById('modal-aiModel').textContent = dataset.aiModel || '-';
            document.getElementById('modal-createdAt').textContent = dataset.createdAt || '-';
            document.getElementById('modal-content').textContent = dataset.content || '';

            // 카테고리 선택 (편집 가능)
            const categoryEnum = dataset.categoryEnum || '';
            document.getElementById('edit-category').value = categoryEnum;

            // 값이 있는지 체크하는 헬퍼 함수
            const hasValue = (value) => value && value !== 'null' && value !== 'undefined';

            // AI 응답 입력 필드
            const responseText = hasValue(dataset.responseText) ? dataset.responseText : '';
            document.getElementById('edit-responseText').value = responseText;

            // 평가 점수 입력 필드들
            const goalAchievement = hasValue(dataset.goalAchievement) ? dataset.goalAchievement : '';
            document.getElementById('edit-goalAchievement').value = goalAchievement;

            const responseQuality = hasValue(dataset.responseQuality) ? dataset.responseQuality : '';
            document.getElementById('edit-responseQuality').value = responseQuality;

            const efficiency = hasValue(dataset.efficiency) ? dataset.efficiency : '';
            document.getElementById('edit-efficiency').value = efficiency;

            const reusability = hasValue(dataset.reusability) ? dataset.reusability : '';
            document.getElementById('edit-reusability').value = reusability;

            const executionSuccess = hasValue(dataset.executionSuccess) ? dataset.executionSuccess : '';
            document.getElementById('edit-executionSuccess').value = executionSuccess;

            const overallSatisfaction = hasValue(dataset.overallSatisfaction) ? dataset.overallSatisfaction : '';
            document.getElementById('edit-overallSatisfaction').value = overallSatisfaction;

            // 코멘트 입력 필드
            const comment = hasValue(dataset.comment) ? dataset.comment : '';
            document.getElementById('edit-comment').value = comment;

            // AI 분석 결과 표시
            const aiAnalysis = hasValue(dataset.aiAnalysis) ? dataset.aiAnalysis : null;
            const aiAnalysisEl = document.getElementById('modal-ai-analysis');
            if (aiAnalysis) {
                aiAnalysisEl.innerHTML = aiAnalysis.replace(/\n/g, '<br>');
                aiAnalysisEl.classList.remove('text-gray-500');
            } else {
                aiAnalysisEl.innerHTML = '<span class="text-gray-500">분석 중...</span>';
            }

            // 모달 표시
            document.getElementById('detailModal').classList.remove('hidden');
        }

        // 프롬프트 저장
        async function savePrompt() {
            if (!currentPromptId) {
                alert('프롬프트 ID를 찾을 수 없습니다.');
                return;
            }

            // 입력 값 검증 (1-10 범위)
            const validateScore = (value) => {
                if (value === '' || value === null) return null;
                const num = parseInt(value);
                if (num < 1 || num > 10) {
                    return false;
                }
                return num;
            };

            const goalAchievement = validateScore(document.getElementById('edit-goalAchievement').value);
            const responseQuality = validateScore(document.getElementById('edit-responseQuality').value);
            const efficiency = validateScore(document.getElementById('edit-efficiency').value);
            const reusability = validateScore(document.getElementById('edit-reusability').value);
            const overallSatisfaction = validateScore(document.getElementById('edit-overallSatisfaction').value);

            // 범위 검증
            if (goalAchievement === false || responseQuality === false || efficiency === false ||
                reusability === false || overallSatisfaction === false) {
                alert('점수는 1-10 사이의 값이어야 합니다.');
                return;
            }

            const executionSuccessValue = document.getElementById('edit-executionSuccess').value;
            const executionSuccess = executionSuccessValue === '' ? null : (executionSuccessValue === 'true');

            const categoryValue = document.getElementById('edit-category').value;
            const category = categoryValue === '' ? null : categoryValue;

            const requestBody = {
                category: category,
                responseText: document.getElementById('edit-responseText').value || null,
                comment: document.getElementById('edit-comment').value || null,
                goalAchievement: goalAchievement,
                executionSuccess: executionSuccess,
                responseQuality: responseQuality,
                efficiency: efficiency,
                reusability: reusability,
                overallSatisfaction: overallSatisfaction
            };

            try {
                const response = await fetch(`/api/prompts/${currentPromptId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    alert('저장되었습니다.');
                    closeModal();
                    // 페이지 새로고침
                    location.reload();
                } else {
                    const error = await response.text();
                    alert('저장 중 오류가 발생했습니다: ' + error);
                }
            } catch (error) {
                alert('저장 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 모달 닫기
        function closeModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('detailModal').classList.add('hidden');
            }
        }

        // 프롬프트 삭제 (테이블에서)
        async function deletePrompt(id) {
            if (!confirm('정말로 이 프롬프트를 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/prompts/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('삭제되었습니다.');
                    location.reload();
                } else {
                    const error = await response.text();
                    alert('삭제 중 오류가 발생했습니다: ' + error);
                }
            } catch (error) {
                alert('삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 프롬프트 삭제 (모달에서)
        async function deletePromptFromModal() {
            if (!currentPromptId) {
                alert('프롬프트 ID를 찾을 수 없습니다.');
                return;
            }

            if (!confirm('정말로 이 프롬프트를 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`/api/prompts/${currentPromptId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('삭제되었습니다.');
                    closeModal();
                    location.reload();
                } else {
                    const error = await response.text();
                    alert('삭제 중 오류가 발생했습니다: ' + error);
                }
            } catch (error) {
                alert('삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
